<!DOCTYPE html>
<html lang="it" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <title>Gestione Mailing List - Gestionale</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .row-selected { background-color: #d1fae5 !important; } /* green-100 */
        .cursor-pointer { cursor: pointer; }
        /* Altezza fissa per le tabelle scrollabili */
        .table-scroll-area { height: 350px; overflow-y: auto; }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-md px-4">
        <div class="flex-1">
            <a href="dashboard_servizi.html" class="btn btn-sm btn-ghost gap-2">
                <i class="fa-solid fa-arrow-left"></i> Torna a Servizi
            </a>
        </div>
        <div class="flex-none">
            <h1 class="text-xl font-bold px-4">Gestione Mailing List</h1>
        </div>
    </div>

    <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- COLONNA SINISTRA: Lista delle Mailing List -->
        <div class="lg:col-span-3 space-y-4">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body p-4">
                    <h2 class="card-title text-sm uppercase text-gray-500">Nuova Lista</h2>
                    <form id="formCreaLista" class="space-y-3">
                        <input type="text" id="descrizioneLista" placeholder="Descrizione (Obbligatoria)" class="input input-bordered w-full input-sm" required />
                        <textarea id="noteLista" placeholder="Note (Opzionale)" class="textarea textarea-bordered w-full textarea-sm"></textarea>
                        <button type="submit" class="btn btn-primary btn-sm w-full">Crea Lista</button>
                    </form>
                </div>
            </div>

            <div class="card bg-base-100 shadow-xl overflow-hidden">
                <div class="card-body p-0">
                    <div class="bg-gray-100 p-3 font-bold text-gray-600 border-b">Elenchi Salvati</div>
                    <div class="overflow-y-auto max-h-[600px]">
                        <ul id="elencoListe" class="menu w-full p-2 rounded-box text-sm">
                            <!-- Popolato via JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLONNA DESTRA: Gestione Dettaglio Lista -->
        <div class="lg:col-span-9">
            <!-- Messaggio Placeholder -->
            <div id="noSelection" class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                <i class="fa-regular fa-envelope-open text-6xl mb-4"></i>
                <p class="text-xl">Seleziona una lista per gestirla</p>
            </div>

            <!-- Contenuto Gestione -->
            <div id="gestioneListaContainer" class="hidden space-y-4">
                
                <!-- Header Lista Selezionata -->
                <div class="card bg-white shadow-sm border-l-8 border-teal-500">
                    <div class="card-body py-3 flex flex-row justify-between items-center flex-wrap gap-4">
                        <div>
                            <h2 id="currentListName" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="currentListNotes" class="text-sm text-gray-500 italic"></p>
                        </div>
                        <div class="flex gap-2">
                            <!-- Dropdown Export -->
                            <div class="dropdown dropdown-end">
                                <label tabindex="0" class="btn btn-sm btn-outline btn-info gap-2">
                                    <i class="fa-solid fa-file-export"></i> Esporta
                                </label>
                                <ul tabindex="0" class="dropdown-content z-[10] menu p-2 shadow bg-base-100 rounded-box w-64">
                                    <li><a onclick="esportaLista('clipboard')"><i class="fa-regular fa-copy"></i> Copia Appunti</a></li>
                                    <li><a onclick="esportaLista('csv')"><i class="fa-solid fa-file-csv"></i> Scarica CSV</a></li>
                                    <li><a onclick="apriModalEML()"><i class="fa-regular fa-envelope"></i> Genera File .EML</a></li>
                                </ul>
                            </div>
                            
                            <button onclick="eliminaListaCorrente()" class="btn btn-error btn-sm btn-outline">
                                <i class="fa-solid fa-trash"></i> Elimina
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SEZIONE RICERCA UNIFICATA -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-4">
                        <h3 class="font-bold text-gray-700 mb-2">Ricerca Destinatari</h3>
                        
                        <div class="flex gap-2 mb-2 items-center">
                            <input type="text" id="searchInput" class="input input-bordered input-sm w-full" placeholder="Cerca per Associazione, Nome Persona o Email (min 3 caratteri)..." />
                            <button onclick="cercaUnificata()" class="btn btn-sm btn-primary px-6"><i class="fa-solid fa-search"></i> Cerca</button>
                        </div>
                        
                        <div class="text-xs text-gray-500 mb-2 italic flex justify-between">
                            <span>Doppio click sulla riga per aggiungere/rimuovere.</span>
                            <span>Risultati trovati: <span id="resCount" class="font-bold">0</span></span>
                        </div>

                        <div class="overflow-x-auto border rounded table-scroll-area">
                            <table class="table table-xs table-pin-rows">
                                <thead class="bg-base-200">
                                    <tr>
                                        <th class="w-1/3">Associazione</th>
                                        <th class="w-1/3">Indirizzo Email</th>
                                        <th class="w-1/4">Appartiene a</th> <!-- NUOVA COLONNA -->
                                        <th class="text-right w-20">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="res-ricerca">
                                    <tr><td colspan="4" class="text-center text-gray-400 py-4">Effettua una ricerca per iniziare</td></tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- Tabella Membri Lista -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-0">
                        <div class="p-4 border-b flex justify-between items-center bg-teal-50 rounded-t-xl">
                            <h3 class="font-bold text-teal-800">
                                <i class="fa-solid fa-list-check"></i> Composizione Lista
                            </h3>
                            <span id="countMembri" class="badge badge-teal font-bold">0</span>
                        </div>
                        <div class="overflow-x-auto h-[400px]">
                            <table class="table table-sm table-pin-rows">
                                <thead>
                                    <tr>
                                        <th>Associazione / Nominativo</th>
                                        <th>Email</th>
                                        <th class="w-24">Tipo Invio</th>
                                        <th class="text-right w-16"></th>
                                    </tr>
                                </thead>
                                <tbody id="tabellaMembri">
                                    <!-- Righe Popolate via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL GENERAZIONE EML -->
    <dialog id="modal_eml" class="modal">
        <form method="dialog" class="modal-box">
            <h3 class="font-bold text-lg"><i class="fa-regular fa-envelope"></i> Genera File .EML</h3>
            <p class="py-2 text-sm text-error font-bold">Nota: I dati inseriti qui servono solo per generare il file e NON verranno salvati nel database.</p>
            
            <div class="form-control w-full mb-3">
                <label class="label"><span class="label-text">Oggetto</span></label>
                <input type="text" id="emlSubject" placeholder="Oggetto della mail..." class="input input-bordered w-full" />
            </div>
            
            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text">Testo / Corpo</span></label>
                <textarea id="emlBody" class="textarea textarea-bordered h-24" placeholder="Scrivi qui il testo..."></textarea>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-ghost">Annulla</button>
                <button type="button" onclick="generaEMLDownload()" class="btn btn-primary">Scarica .EML</button>
            </div>
        </form>
    </dialog>

    <!-- Script Logica -->
    <script>
        let selectedListId = null;
        let currentMembers = []; 
        let currentMembersMap = new Map(); 

        document.addEventListener('DOMContentLoaded', () => {
            caricaListe();
            
            // Enter key listener
            document.getElementById('searchInput').addEventListener('keyup', e => { if(e.key==='Enter') cercaUnificata(); });

            document.getElementById('formCreaLista').addEventListener('submit', async (e) => {
                e.preventDefault();
                const desc = document.getElementById('descrizioneLista').value;
                const note = document.getElementById('noteLista').value;
                try {
                    const res = await fetch('/api/maillist', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ Descrizione: desc, Note: note })
                    });
                    const data = await res.json();
                    if(data.success) {
                        document.getElementById('formCreaLista').reset();
                        caricaListe();
                    } else alert("Errore: " + data.error);
                } catch(err) { console.error(err); }
            });
        });

        async function caricaListe() {
            try {
                const res = await fetch('/api/maillist');
                const liste = await res.json();
                const container = document.getElementById('elencoListe');
                container.innerHTML = '';
                liste.forEach(lista => {
                    const li = document.createElement('li');
                    const isActive = selectedListId === lista.ID ? 'active' : '';
                    li.innerHTML = `<a onclick="selezionaLista(${lista.ID}, '${lista.Descrizione.replace(/'/g, "\\'")}', '${(lista.Note||'').replace(/'/g, "\\'")}')" class="${isActive}">${lista.Descrizione}</a>`;
                    container.appendChild(li);
                });
            } catch(e) { console.error(e); }
        }

        function selezionaLista(id, desc, note) {
            selectedListId = id;
            document.getElementById('currentListName').textContent = desc;
            document.getElementById('currentListNotes').textContent = note;
            document.getElementById('noSelection').classList.add('hidden');
            document.getElementById('gestioneListaContainer').classList.remove('hidden');
            
            // Reset Risultati Ricerca ma mantieni input se c'è
            if(document.getElementById('searchInput').value.length >= 3) {
                cercaUnificata();
            } else {
                document.getElementById('res-ricerca').innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-4">Effettua una ricerca per iniziare</td></tr>';
                document.getElementById('resCount').textContent = '0';
            }

            caricaMembriLista();
            caricaListe(); 
        }

        async function caricaMembriLista() {
            if(!selectedListId) return;
            try {
                const res = await fetch(`/api/maillist/${selectedListId}/members`);
                currentMembers = await res.json();
                
                currentMembersMap.clear();
                currentMembers.forEach(m => {
                    currentMembersMap.set(m.Indirizzo.toLowerCase(), { id: m.ID, tipo: m.TipoInvio });
                });

                document.getElementById('countMembri').textContent = currentMembers.length;
                renderTabellaMembri();
                
                // Aggiorna stato tabella ricerca se popolata
                const searchResContainer = document.getElementById('res-ricerca');
                if(searchResContainer.children.length > 0 && !searchResContainer.textContent.includes('Effettua una ricerca')) {
                    // Rieseguiamo il rendering delle righe correnti per aggiornare i colori
                    reRenderRicerca();
                }

            } catch(e) { console.error(e); }
        }

        function renderTabellaMembri() {
            const tbody = document.getElementById('tabellaMembri');
            tbody.innerHTML = '';
            currentMembers.forEach(r => {
                const tr = document.createElement('tr');
                let badgeClass = r.TipoInvio === 'A' ? 'badge-primary' : (r.TipoInvio === 'CC' ? 'badge-info' : 'badge-ghost');
                
                tr.innerHTML = `
                    <td class="font-semibold text-xs">${r.SOGGETTO}</td>
                    <td>
                        <div class="font-mono text-xs">${r.Indirizzo}</div>
                        ${r.Predefinito ? '<span class="text-[9px] text-green-600 font-bold">PREDEFINITO</span>' : ''}
                    </td>
                    <td>
                         <div class="dropdown dropdown-hover dropdown-left">
                            <label tabindex="0" class="badge ${badgeClass} badge-sm cursor-pointer">${r.TipoInvio || 'CCN'}</label>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-1 shadow bg-base-100 rounded-box w-16">
                                <li><a onclick="cambiaTipo(${r.ID}, 'A')" class="text-xs px-2 py-1">A</a></li>
                                <li><a onclick="cambiaTipo(${r.ID}, 'CC')" class="text-xs px-2 py-1">CC</a></li>
                                <li><a onclick="cambiaTipo(${r.ID}, 'CCN')" class="text-xs px-2 py-1">CCN</a></li>
                            </ul>
                        </div>
                    </td>
                    <td class="text-right">
                        <button onclick="rimuoviMembro(${r.ID})" class="btn btn-ghost btn-xs text-error"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- NUOVA LOGICA DI RICERCA UNIFICATA ---
        let lastSearchResults = []; // Cache ultimi risultati

        async function cercaUnificata() {
            const q = document.getElementById('searchInput').value;
            if (q.length < 3) { alert("Inserisci almeno 3 caratteri"); return; }
            
            try {
                const res = await fetch(`/api/maillist/search/unified?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                lastSearchResults = data;
                renderRisultatiUnificati(data);
            } catch(e) { console.error(e); }
        }

        function reRenderRicerca() {
            if(lastSearchResults.length > 0) renderRisultatiUnificati(lastSearchResults);
        }

        function renderRisultatiUnificati(rows) {
            const container = document.getElementById('res-ricerca');
            document.getElementById('resCount').textContent = rows.length;
            container.innerHTML = '';
            
            if (rows.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-4">Nessun risultato trovato</td></tr>';
                return;
            }

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover cursor-pointer select-none transition-colors duration-150"; 
                
                // Dati
                const email = row.Indirizzo;
                const assocName = row.SOGGETTO || 'Sconosciuto';
                const fonte = row.Fonte; // "Associazione", "Referente: Nome", "Altro: Nome"
                const idMail = row.IDMail; // Può essere null se Referente/Altro
                const idAssoc = row.IDAssociazione;
                const isPredef = row.Predefinito === 1;

                // Check esistenza in lista
                const existing = currentMembersMap.get(email.toLowerCase());
                
                // HTML Colonne
                let emailHtml = `<span class="font-mono text-xs">${email}</span>`;
                if(isPredef) emailHtml += `<span class="badge badge-xs badge-success ml-2">Predef</span>`;

                // Colonna Fonte con icona diversa
                let iconFonte = '<i class="fa-solid fa-building text-gray-400 mr-1"></i>';
                if(fonte.startsWith('Ref')) iconFonte = '<i class="fa-solid fa-user-tie text-blue-400 mr-1"></i>';
                if(fonte.startsWith('Altro')) iconFonte = '<i class="fa-solid fa-user text-orange-400 mr-1"></i>';

                let fonteHtml = `<div class="text-xs text-gray-600 flex items-center">${iconFonte} ${fonte}</div>`;

                // Azioni
                let actions = '';
                if (existing) {
                    tr.classList.add("row-selected");
                    actions = `
                        <span class="badge badge-sm badge-neutral mr-2">${existing.tipo}</span>
                        <button class="btn btn-xs btn-circle btn-ghost text-error" onclick="rimuoviMembro(${existing.id})"><i class="fa-solid fa-times"></i></button>
                    `;
                    tr.ondblclick = () => rimuoviMembro(existing.id);
                } else {
                    actions = `<span class="text-[10px] text-gray-400">Doppio click</span>`;
                    tr.ondblclick = () => toggleSelectionDisplay(tr, idMail, email, idAssoc);
                }

                tr.innerHTML = `
                    <td><div class="font-bold text-xs truncate max-w-[200px]" title="${assocName}">${assocName}</div></td>
                    <td>${emailHtml}</td>
                    <td>${fonteHtml}</td>
                    <td class="text-right action-cell">${actions}</td>
                `;
                
                container.appendChild(tr);
            });
        }

        // Mostra i pulsanti A/CC/CCN nella cella azioni
        function toggleSelectionDisplay(tr, idMail, email, idAssoc) {
            const cell = tr.querySelector('.action-cell');
            if (cell.querySelector('.btn-join')) {
                cell.innerHTML = `<span class="text-[10px] text-gray-400">Doppio click</span>`;
                return;
            }
            
            const div = document.createElement('div');
            div.className = "join btn-join";
            div.innerHTML = `
                <button class="btn btn-xs join-item btn-primary" onclick="aggiungiMembro('${idMail}', '${email}', '${idAssoc}', 'A')">A</button>
                <button class="btn btn-xs join-item btn-info" onclick="aggiungiMembro('${idMail}', '${email}', '${idAssoc}', 'CC')">CC</button>
                <button class="btn btn-xs join-item btn-neutral" onclick="aggiungiMembro('${idMail}', '${email}', '${idAssoc}', 'CCN')">CCN</button>
            `;
            cell.innerHTML = '';
            cell.appendChild(div);
        }

        async function aggiungiMembro(idMail, email, idAssoc, tipo) {
            // idMail potrebbe arrivare come stringa 'null' dal template HTML
            const realIdMail = (idMail && idMail !== 'null') ? idMail : null;
            
            const payload = {
                IDMail: realIdMail,
                EmailRaw: email,
                IDAssociazione: idAssoc,
                TipoInvio: tipo
            };

            try {
                const res = await fetch(`/api/maillist/${selectedListId}/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    caricaMembriLista(); // Ricarica e aggiorna la UI
                } else {
                    alert("Errore inserimento: " + data.error);
                }
            } catch(e) { console.error(e); }
        }

        async function rimuoviMembro(idRiga) {
            try {
                const res = await fetch(`/api/maillist/member/${idRiga}`, { method: 'DELETE' });
                if ((await res.json()).success) caricaMembriLista();
            } catch(e) { console.error(e); }
        }

        async function cambiaTipo(idRiga, nuovoTipo) {
            try {
                const res = await fetch(`/api/maillist/member/${idRiga}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ TipoInvio: nuovoTipo })
                });
                if ((await res.json()).success) caricaMembriLista();
            } catch(e) { console.error(e); }
        }

        async function eliminaListaCorrente() {
            if(!selectedListId || !confirm("Eliminare questa lista?")) return;
            try {
                const res = await fetch(`/api/maillist/${selectedListId}`, { method: 'DELETE' });
                if ((await res.json()).success) {
                    selectedListId = null;
                    document.getElementById('gestioneListaContainer').classList.add('hidden');
                    document.getElementById('noSelection').classList.remove('hidden');
                    caricaListe();
                }
            } catch(e) { console.error(e); }
        }

        // --- EXPORT & EML (Invariati nella logica, ma inclusi per completezza) ---
        function esportaLista(modo) {
            if(!currentMembers.length) { alert("Lista vuota"); return; }
            if (modo === 'clipboard') {
                const map = { 'A': [], 'CC': [], 'CCN': [] };
                currentMembers.forEach(m => {
                    const t = m.TipoInvio || 'CCN';
                    map[t].push(`"${m.SOGGETTO.replace(/"/g, '')}" <${m.Indirizzo}>`);
                });
                let txt = "";
                if(map.A.length) txt += "A: " + map.A.join('; ') + "\n";
                if(map.CC.length) txt += "CC: " + map.CC.join('; ') + "\n";
                if(map.CCN.length) txt += "CCN: " + map.CCN.join('; ');
                navigator.clipboard.writeText(txt).then(() => alert("Copiato!"));
            } else if (modo === 'csv') {
                let csv = "Nome,Email,Tipo\n" + currentMembers.map(m => `"${m.SOGGETTO.replace(/"/g,'""')}","${m.Indirizzo}","${m.TipoInvio||'CCN'}"`).join('\n');
                const a = document.createElement('a');
                a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                a.download = 'lista.csv';
                a.click();
            }
        }

        function apriModalEML() {
            if(!currentMembers.length) { alert("Lista vuota"); return; }
            document.getElementById('modal_eml').showModal();
        }

        function generaEMLDownload() {
            const subject = document.getElementById('emlSubject').value || "Oggetto Mail";
            const body = document.getElementById('emlBody').value || "";
            const map = { 'To': [], 'Cc': [], 'Bcc': [] };
            currentMembers.forEach(m => {
                const dest = `"${m.SOGGETTO.replace(/"/g, '')}" <${m.Indirizzo}>`;
                if(m.TipoInvio === 'A') map.To.push(dest);
                else if(m.TipoInvio === 'CC') map.Cc.push(dest);
                else map.Bcc.push(dest);
            });
            const toHeader = map.To.length > 0 ? map.To.join(', ') : "undisclosed-recipients:;";
            let emlContent = `MIME-Version: 1.0\nX-Unsent: 1\nSubject: ${subject}\nTo: ${toHeader}\n`;
            if (map.Cc.length) emlContent += `Cc: ${map.Cc.join(', ')}\n`;
            if (map.Bcc.length) emlContent += `Bcc: ${map.Bcc.join(', ')}\n`;
            emlContent += `Content-Type: text/plain; charset=UTF-8\n\n${body}`;
            const blob = new Blob([emlContent], { type: 'message/rfc822' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${subject.replace(/[^a-z0-9]/gi, '_').substring(0, 20)}.eml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>