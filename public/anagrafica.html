<!DOCTYPE html>
<html lang="it" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anagrafica Enti - Gestionale</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-box { max-width: 900px; }
        #searchResults { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="bg-base-200 min-h-screen relative p-6">

    <!-- Torna alla Dashboard Iniziale -->
    <a href="/" class="btn btn-sm btn-neutral absolute top-4 left-4 shadow-md z-10">
        ‚¨Ö Dashboard
    </a>

    <div class="container mx-auto max-w-7xl mt-12">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-6">
            <div>
                <h1 class="text-4xl font-black uppercase text-blue-800">
                    Anagrafica Enti
                </h1>
                <p class="text-gray-500 font-bold mt-1">Elenco Generale</p>
                <p class="text-xs text-gray-400 mt-2" id="recordCounter">Caricamento...</p>
            </div>
            
            <div class="flex gap-3 mt-4 md:mt-0 items-end">
                <!-- Filtro Tipologia -->
                <div class="form-control w-full max-w-xs">
                    <label class="label py-0"><span class="label-text text-xs font-bold">Filtra per Tipologia</span></label>
                    <select id="filtroTipologia" class="select select-bordered select-sm w-full" onchange="filtraTabella()">
                        <option value="">-- Tutte --</option>
                    </select>
                </div>

                <!-- Ricerca Testuale -->
                <div class="join shadow-sm">
                    <input type="text" id="searchInput" placeholder="üîç Cerca ente, CF o nome..." class="input input-sm input-bordered join-item w-full max-w-xs focus:outline-none" onkeyup="filtraTabella()" />
                </div>
                
                <!-- Nuovo Ente -->
                <button onclick="apriModaleNuovo()" class="btn btn-sm btn-primary text-white shadow-md border-none bg-blue-600 hover:bg-blue-700">
                    ‚ûï Nuovo Ente
                </button>
            </div>
        </div>

        <div class="card bg-white shadow-xl border-t-8 border-blue-600">
            <div class="card-body p-0">
                <div class="overflow-x-auto rounded-b-xl min-h-[400px]">
                    <table class="table table-zebra w-full" id="tabellaEnti">
                        <thead class="bg-gray-100 text-blue-900 uppercase text-sm font-bold border-b-2 border-gray-200">
                            <tr>
                                <th class="w-1/4 py-4">Soggetto / Ente</th>
                                <th class="w-1/6 py-4">Tipologia</th>
                                <th class="w-1/4 py-4">Referenti & Altri Soggetti</th>
                                <th class="w-1/4 py-4">Incarichi</th> 
                                <th class="text-center py-4">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Caricamento dati...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Paginazione -->
                <div class="flex justify-between items-center p-4 border-t bg-gray-50" id="paginationControls">
                    <button class="btn btn-sm" onclick="cambiaPagina(-1)">¬´ Prec</button>
                    <span class="text-sm font-bold text-gray-600" id="pageIndicator">Pagina 1</span>
                    <button class="btn btn-sm" onclick="cambiaPagina(1)">Succ ¬ª</button>
                </div>
            </div>
        </div>
    </div>

<!-- MODALE SOLO NUOVO INSERIMENTO -->
    <div id="modalNuovo" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-auto max-h-[90vh] flex flex-col overflow-hidden">
            
            <!-- Header Modale -->
            <div class="bg-blue-600 p-4 flex justify-between items-center flex-shrink-0">
                <h3 class="text-white text-xl font-bold uppercase">Nuovo Ente</h3>
                <button onclick="chiudiModale()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>

            <!-- Corpo Modale (Scrollabile se necessario) -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="formNuovo" onsubmit="creaEnte(event)">
                    
                    <!-- BOX RICERCA RUNTS (SEMPLIFICATO) -->
                    <div class="mb-6 bg-yellow-50 border border-yellow-300 rounded-lg p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üèõÔ∏è</span>
                            <div>
                                <h4 class="font-bold text-yellow-900 text-lg">Importa da RUNTS</h4>
                                <p class="text-xs text-yellow-700">Cerca per <b>Denominazione</b> o <b>Cognome Referente</b>.</p>
                            </div>
                        </div>
                        
                        <!-- Input Unico -->
                        <div class="form-control w-full relative">
                            <input type="text" id="searchRuntsInput" 
                                class="input input-lg input-bordered w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-400" 
                                placeholder="Scrivi qui per cercare..." 
                                autocomplete="off"
                                onkeyup="handleRuntsSearch()">
                                
                            <!-- Loader -->
                            <div id="runtsLoader" class="absolute right-4 top-4 hidden">
                                <span class="loading loading-spinner loading-sm text-yellow-600"></span>
                            </div>
                        </div>

                        <!-- Contenitore Risultati (Con scroll interno) -->
                        <div id="resultsContainer" class="mt-3 hidden">
                            <label class="label text-xs font-bold uppercase text-gray-500 pb-1">Risultati trovati:</label>
                            <div id="searchResults" class="bg-white border border-gray-300 rounded-lg shadow-inner max-h-48 overflow-y-auto divide-y divide-gray-100">
                                <!-- I risultati vengono inseriti qui via JS -->
                            </div>
                        </div>
                    </div>
                    <!-- FINE RICERCA RUNTS -->

                    <hr class="border-gray-200 mb-6">

                    <!-- FORM DATI ENTE -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                        <div class="form-control md:col-span-2">
                            <label class="label font-bold text-sm text-gray-700">Denominazione Ente *</label>
                            <input type="text" name="SOGGETTO" id="NEW_SOGGETTO" class="input input-bordered w-full" required>
                        </div>
                        <div class="form-control">
                            <label class="label font-bold text-sm text-gray-700">Codice Fiscale</label>
                            <input type="text" name="CODICEFISCALE" id="NEW_CF" class="input input-bordered w-full uppercase tracking-wider" maxlength="16">
                        </div>
                        <div class="form-control">
                            <label class="label font-bold text-sm text-gray-700">Tipologia</label>
                            <select name="ID_TIPOLOGIA" id="NEW_TIPOLOGIA" class="select select-bordered w-full" onchange="toggleIncarichiNuovo()">
                                <!-- Popolato via JS -->
                            </select>
                        </div>
                    </div>

                    <div id="divIncarichiNuovo" class="bg-blue-50 p-4 rounded-lg border border-blue-100 hidden mb-6">
                        <h4 class="text-sm font-bold text-blue-800 mb-2">Incarichi Associativi</h4>
                        <div class="flex gap-6">
                            <label class="cursor-pointer flex items-center gap-2">
                                <input type="checkbox" name="TAVOLO" id="NEW_TAVOLO" class="checkbox checkbox-primary checkbox-sm" value="1">
                                <span class="label-text font-semibold">Membro del Tavolo</span>
                            </label>
                            <label class="cursor-pointer flex items-center gap-2">
                                <input type="checkbox" name="DIRETTIVO_DELEGAZIONE" id="NEW_DIRETTIVO" class="checkbox checkbox-secondary checkbox-sm" value="1">
                                <span class="label-text font-semibold">Direttivo Delegazione</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-100">
                        <button type="button" onclick="chiudiModale()" class="btn btn-ghost">Annulla</button>
                        <button type="submit" class="btn btn-primary text-white px-8">Salva Ente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABILI GLOBALI ---
        let listaTipologie = [];
        let listaEnti = [];
        let listaEntiFiltrata = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let pendingRuntsReferente = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await caricaTipologie();
            await caricaDati();
        });

        // --- CARICAMENTO DATI ---
        async function caricaTipologie() {
            try {
                const res = await fetch('/api/tipologie');
                listaTipologie = await res.json();
                const filterSel = document.getElementById('filtroTipologia');
                const newSel = document.getElementById('NEW_TIPOLOGIA');
                let opts = '<option value="">-- Seleziona --</option>';
                listaTipologie.forEach(t => {
                    const opt = `<option value="${t.ID}">${t.Tipologia}</option>`;
                    filterSel.innerHTML += `<option value="${t.ID}">${t.Tipologia}</option>`;
                    opts += opt;
                });
                newSel.innerHTML = opts;
            } catch (err) { console.error(err); }
        }

        async function caricaDati() {
            try {
                const [resEnti, resRef, resAltri] = await Promise.all([
                    fetch('/api/associazioni'),
                    fetch('/api/all-referenti'),
                    fetch('/api/all-altri-soggetti')
                ]);
                const enti = await resEnti.json();
                const referenti = await resRef.json();
                const altriSoggetti = await resAltri.json();

                const mapRef = {};
                referenti.forEach(r => {
                    if(!mapRef[r.ID_Associazione]) mapRef[r.ID_Associazione] = [];
                    mapRef[r.ID_Associazione].push(r.Nome);
                });
                const mapAltri = {};
                altriSoggetti.forEach(a => {
                    if(!mapAltri[a.ID_Associazione]) mapAltri[a.ID_Associazione] = [];
                    mapAltri[a.ID_Associazione].push(a.Nome);
                });

                listaEnti = enti.map(e => {
                    const refs = mapRef[e.ID] || [];
                    const altri = mapAltri[e.ID] || [];
                    const searchString = [...refs, ...altri].join(' ');
                    return { ...e, RefList: refs, AltriList: altri, SearchString: searchString };
                });
                filtraTabella();
            } catch (err) { console.error(err); }
        }

        // --- TABELLA E PAGINAZIONE ---
        function filtraTabella() {
            const text = document.getElementById('searchInput').value.toLowerCase();
            const tipoFilter = document.getElementById('filtroTipologia').value;
            listaEntiFiltrata = listaEnti.filter(item => {
                const matchText = (item.SOGGETTO && item.SOGGETTO.toLowerCase().includes(text)) ||
                                  (item.CODICEFISCALE && item.CODICEFISCALE.toLowerCase().includes(text)) ||
                                  (item.SearchString && item.SearchString.toLowerCase().includes(text));
                const matchTipo = tipoFilter === "" || (item.ID_TIPOLOGIA == tipoFilter);
                return matchText && matchTipo;
            });
            currentPage = 1;
            renderTabella();
        }

        function renderTabella() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const data = listaEntiFiltrata.slice(start, end);
            const tbody = document.getElementById('tableBody');
            document.getElementById('recordCounter').innerText = `Totale record: ${listaEntiFiltrata.length}`;
            document.getElementById('pageIndicator').innerText = `Pagina ${currentPage} di ${Math.ceil(listaEntiFiltrata.length/itemsPerPage) || 1}`;
            
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Nessun dato trovato</td></tr>'; return; }
            
            tbody.innerHTML = data.map(row => {
                let incarichi = '';
                if (row.TAVOLO == 1) incarichi += `<span class="badge badge-primary text-white text-xs mr-1">Tavolo</span>`;
                if (row.DIRETTIVO_DELEGAZIONE == 1) incarichi += `<span class="badge badge-secondary text-white text-xs">Direttivo</span>`;
                let personeHtml = '';
                if (row.RefList && row.RefList.length > 0) {
                    personeHtml += row.RefList.map(n => `<div class="text-sm font-semibold text-gray-700">üë§ ${n}</div>`).join('');
                }
                if (row.AltriList && row.AltriList.length > 0) {
                    if (personeHtml) personeHtml += '<div class="mt-1 border-t border-gray-100"></div>';
                    personeHtml += row.AltriList.map(n => `<div class="text-xs text-gray-500 italic">üë• ${n}</div>`).join('');
                }
                return `
                <tr class="hover:bg-blue-50 cursor-pointer border-b" onclick="apriDettaglio(${row.ID})">
                    <td class="font-bold text-blue-900 align-top">
                        ${row.SOGGETTO}
                        <div class="text-xs text-gray-400 font-mono font-normal">${row.CODICEFISCALE || ''}</div>
                    </td>
                    <td class="align-top"><div class="badge badge-ghost">${row.Tipologia_Nome || '-'}</div></td>
                    <td class="align-top"><div class="flex flex-col gap-1">${personeHtml}</div></td>
                    <td class="align-top">${incarichi}</td>
                    <td class="text-center align-top"><button class="btn btn-sm btn-ghost text-blue-600">‚úèÔ∏è Apri</button></td>
                </tr>`;
            }).join('');
        }

        function cambiaPagina(delta) {
            const tot = Math.ceil(listaEntiFiltrata.length / itemsPerPage) || 1;
            const next = currentPage + delta;
            if(next >= 1 && next <= tot) { currentPage = next; renderTabella(); }
        }

        function apriDettaglio(id) { window.location.href = `/anagrafica_singola?id=${id}`; }

        // --- FUNZIONI MODALE NUOVO ---
        function apriModaleNuovo() {
            document.getElementById('formNuovo').reset();
            // Reset ricerca
            document.getElementById('searchRuntsInput').value = "";
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('searchResults').innerHTML = "";
            
            document.getElementById('divIncarichiNuovo').classList.add('hidden');
            document.getElementById('modalNuovo').classList.remove('hidden');
            pendingRuntsReferente = null;
        }

        function chiudiModale() { document.getElementById('modalNuovo').classList.add('hidden'); }
        
        function toggleIncarichiNuovo() {
            const val = document.getElementById('NEW_TIPOLOGIA').value;
            const div = document.getElementById('divIncarichiNuovo');
            if(val == '1') div.classList.remove('hidden'); else div.classList.add('hidden');
        }

        // --- NUOVA RICERCA RUNTS (Versione Unificata) ---
        let runtsTimeout = null;
        
// ... (parte precedente della funzione)

        async function handleRuntsSearch() {
            clearTimeout(runtsTimeout);
            const term = document.getElementById('searchRuntsInput').value;
            const resContainer = document.getElementById('searchResults');
            const mainContainer = document.getElementById('resultsContainer');
            const loader = document.getElementById('runtsLoader');

            if(term.length < 3) { 
                mainContainer.classList.add('hidden'); 
                return; 
            }

            loader.classList.remove('hidden');

            runtsTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/runts/search?q=${encodeURIComponent(term)}`);
                    const results = await res.json();
                    
                    loader.classList.add('hidden');
                    resContainer.innerHTML = '';
                    mainContainer.classList.remove('hidden');

                    if(results.length > 0) {
                        results.forEach(item => {
                            const div = document.createElement('div');
                            div.className = "p-3 hover:bg-yellow-100 cursor-pointer flex flex-col transition-colors border-b last:border-0";
                            
                            // MODIFICA QUI: Mostra badge solo se c'√® la provincia
                            const provBadge = item.Provincia 
                                ? `<span class="badge badge-sm badge-neutral text-white ml-2">${item.Provincia}</span>` 
                                : ``; 
                                
                            const refInfo = (item.Cognome && item.Nome) 
                                ? `<div class="text-xs text-blue-600 mt-1">üë§ Ref: <b>${item.Cognome} ${item.Nome}</b></div>` 
                                : ``;

                            div.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <span class="font-bold text-gray-800 text-sm">${item.Denominazione}</span>
                                    ${provBadge}
                                </div>
                                <div class="flex justify-between items-end mt-1">
                                    <span class="text-xs font-mono bg-gray-100 px-1 rounded text-gray-600">${item.CodiceFiscale || 'CF MANCANTE'}</span>
                                </div>
                                ${refInfo}
                            `;
                            
                            div.onclick = () => selectRuntsResult(item);
                            resContainer.appendChild(div);
                        });
                    } else {
                        resContainer.innerHTML = `
                            <div class="p-4 text-center text-gray-400 text-sm italic">
                                Nessun risultato trovato per "${term}".
                            </div>`;
                    }
                } catch(e) { 
                    console.error(e); 
                    loader.classList.add('hidden');
                }
            }, 400);
        }
        
        function selectRuntsResult(item) {
            // Compila campi
            document.getElementById('NEW_SOGGETTO').value = item.Denominazione;
            document.getElementById('NEW_CF').value = item.CodiceFiscale;
            const sel = document.getElementById('NEW_TIPOLOGIA');
            sel.value = "1"; // Default a 1 (presumibilmente ETS/ODV)
            sel.dispatchEvent(new Event('change'));
            
            // Gestione Referente
            if(item.Cognome && item.Nome) {
                pendingRuntsReferente = `${item.Cognome} ${item.Nome}`.toUpperCase();
                
                // Feedback utente visivo
                const input = document.getElementById('searchRuntsInput');
                input.value = ""; // Pulisce input
                input.placeholder = `‚úÖ Selezionato: ${item.Denominazione}`;
                document.getElementById('resultsContainer').classList.add('hidden');
                
                // Alert Toast temporaneo
                const toast = document.createElement('div');
                toast.className = "alert alert-success fixed top-5 left-1/2 transform -translate-x-1/2 w-auto shadow-lg z-[60] animate-bounce";
                toast.innerHTML = `<span>Dati caricati!<br>Referente rilevato: <b>${pendingRuntsReferente}</b></span>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } else {
                pendingRuntsReferente = null;
                document.getElementById('resultsContainer').classList.add('hidden');
            }
        }

        async function creaEnte(e) {
            e.preventDefault();
            const data = {
                SOGGETTO: document.getElementById('NEW_SOGGETTO').value.toUpperCase(),
                CODICEFISCALE: document.getElementById('NEW_CF').value.toUpperCase().replace(/\s/g, ''),
                ID_TIPOLOGIA: document.getElementById('NEW_TIPOLOGIA').value,
                TAVOLO: document.getElementById('NEW_TAVOLO').checked,
                DIRETTIVO_DELEGAZIONE: document.getElementById('NEW_DIRETTIVO').checked
            };

            try {
                const res = await fetch('/api/associazioni', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if(res.ok) {
                    const json = await res.json();
                    if(pendingRuntsReferente) {
                        await fetch('/api/referenti', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ID_Associazione: json.id, Nome: pendingRuntsReferente})
                        });
                    }
                    window.location.href = `/anagrafica_singola?id=${json.id}`;
                } else {
                    alert("Errore: Impossibile creare l'ente. Controlla che il CF o la Denominazione non esistano gi√†.");
                }
            } catch(err) { console.error(err); alert("Errore di rete"); }
        }
    </script>
</body>
</html>